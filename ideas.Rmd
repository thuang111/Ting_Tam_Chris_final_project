---
title: "COMP 112 FINAL PROJECT"
author: "Tam, Ting and Chris"
output: 
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_download: true
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

[link to git collab](https://github.com/thuang111/Ting_Tam_Chris_final_project)

```{r libraries}
library(tidyverse)     # for graphing and data cleaning
library(lubridate)     # for date manipulation
library(ggthemes)# for even more plotting themes
library(janitor)
library(geomtextpath)
library(tidyr)
library(maps)          # for map data
library(ggmap)         # for mapping points on maps
library(patchwork)
library(tidytext)
theme_set(theme_minimal()) # My favorite ggplot() theme :)
```

```{r loading world bank pop and world map}
data("world_bank_pop") #pop data only available from 2000 to 2017. So we might want to filter out some years from the original data set - Tam
world_map <- map_data("world") %>%  #coordinates of countries
  rename(country = region) %>% 
  select(-subregion)

```




```{r reordering world bank pop dataset}
world_pop_new <- world_bank_pop %>% 
  pivot_longer(cols = starts_with("20") ,
              names_to = "year",
              values_to = "value") %>% 
  pivot_wider(names_from = indicator,
              values_from =  value) %>% 
  rename(country_code = country, population_growth = SP.POP.GROW ,  total_population = SP.POP.TOTL, urban_population_growth = SP.URB.GROW , total_urban_population = SP.URB.TOTL)
```

```{r loading raw cancer data}
cancer_og <- read_csv("total-cancer-deaths-by-type.csv")
```


```{r cleaning up the variables}
cancer <- cancer_og %>% 
  pivot_longer(cols = starts_with("Death"),
               names_to = "Type_of_cancer",
               values_to = "Death_count") %>% 
  mutate(Cancer_type = str_sub(Type_of_cancer, 10, -37)) %>% 
  select(-Type_of_cancer)
```





```{r, fig.alt = "This line graph shows the top 5 types of cancer worldwide and the USA that have increased the most since 1990. The cancer with the highest growth rate is trachael, bronchus, and lunger cancer, having almost doubled since 1990. Colon and rectal cancer is similar, having gone up around 90% in the past 30 years worldwide. In comparison, the USA has both of those as their top 2 cancers with the highest growth rate, however they are closer to 30% and 15%, respectively."}
#compare world and US top 5 popular cancer types over time
USA_cancer <- cancer %>% 
  filter(Code == "USA") %>% 
  group_by(Year, Cancer_type) %>% 
  summarize(total_count_us = sum(Death_count)/1000) %>% 
  slice_max(total_count_us, n=5) %>%
  ggplot(aes(x = Year, y = total_count_us, color = Cancer_type, label = Cancer_type)) +
  geom_textline(aes(label = Cancer_type), size = 3, vjust = -0.5)+
  labs(x = "", 
       y = "",
       title = "Number of Cancer Deaths in the US, in thousands, from 1990-2019 by Type of Cancer",
       color = "Cancer") +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank())

World_cancer <- cancer %>% 
  group_by(Year, Cancer_type) %>% 
  summarize(total_count = sum(Death_count)/1000) %>% 
  slice_max(total_count, n=5) %>%
  ggplot(aes(x = Year, y = total_count, color = Cancer_type, label = Cancer_type)) +
  geom_textline(aes(label = Cancer_type), size = 3, vjust = -0.5)+ 
  labs(x = "",
       y = "",
       title = "Number of Cancer Deaths, in thousands, Worldwide from 1990-2019 by Type of Cancer",
       color = "Cancer") +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank())

World_cancer + USA_cancer

#You know how to create a legend consisting of only shared cancer types for world and Usa? We can also adjust width and height of fig to show the graphs better - Tam

```

Discussion: 
Compare
Trachael, bronchus, and lung cancer causes most death by far for both world and USA. Furthermore, both world and the USA have colon and rectum cancer, pancreatic cancer and breast cancer in their top 5.
Contrast
For USA, top 5 cancers stayed the same over time, only the ranks changed, however, for the world, we could also see the fifth position change to a different cancer type every 10 years or so. Moreover, while stomach cancer is a huge problem for the world, this isn't the case for the US.

Most cancer deaths rise less extremely than lung cancer **where did you observe this? - Tam**


Q1: We are also interested to see which countries led the world in terms of death per 1,000 people. Which countries were in the top 5 (?) in the year 2000,2008 and 2017?
Q2: Rising death counts may correlate with rising world population (i.e total growth, urban growth)? **I have downloaded the dataset that does just this, check out world_pop_new - Tam**
Q3: In those countries, what are the cancer types that have caused the most deaths per 1000 people?


```{r}
#Join the cancer and the population datasets
cancer_pop <- 
  cancer %>% 
  rename(country_code = Code, year = Year, country = Entity) %>% 
  group_by(country_code, year, country) %>% 
  summarize(death = sum(Death_count)) %>% 
  ungroup() %>% 
  filter(!year %in% c(1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2018,2019)) %>% 
  left_join(world_pop_new %>% 
              mutate(year = as.numeric(year)),
            by = c("country_code","year")) %>% 
  mutate(death_per_urban = death/total_urban_population*1000 , death_per_total = death/ total_population*1000)

cancer_pop
```


```{r continuing question Q1, make use of the world_pop_new dataset}
top_5_cancer_pop <-cancer_pop %>% 
  select(country, country_code, year, death, total_urban_population,death_per_urban, total_population, death_per_total)

top_5_cancer_pop
```

```{r, fig.alt = "This bar chart shows the countries with top 5 cancer mortality rate per 1000 people in 2000, 2008, and 2017. Monaco has the highest mortality rate in all three time periods, being around 40% greater than second place each time. Serbia seems to have an increased mortality rate in recent years, having the second highest mortaility rate in 2008 and 2017.Denmark, Germany, and Hungary are the other countries that are seen multiple times on the bar graph, with both countries being off the chart in 2017."}
#death per 1000 capita
fig2a <- top_5_cancer_pop %>% 
  filter(year %in% c(2000,2008,2017)) %>% 
  group_by(year) %>% 
  slice_max(death_per_total, n = 5) %>% 
  ungroup() %>% 
  mutate(country = reorder_within(country, death_per_total, as.character(year), fun = sum, sep = "___")) %>% 
  ggplot(aes(y = country, x = death_per_total, fill = country)) +
  geom_col()+
  scale_fill_viridis_d()+ #scale_fill to show that death rates actually increased over time. We are seeing more and more light colors than dark ones.
  facet_wrap(~year, scales = "free_y")+
  scale_y_reordered()+
  labs(title = "Top 5 countries with highest percentage of deaths per 1000 people in 2000, 2008 and 2017",
       x = "",
       y = "",
       fill = "Percentage of Death Count")+
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank())

fig2a
```

**Should we do top 5 or top 10?**
2000-2008: no change in countries, but the ranks did change
2008-2017: new names appeared
\
\
Specifically:
- Monaco took the lead, Serbia and Hungary  

Why? -> Maybe do some research for possible explanations? The link below may help, idk.

[Cancer death rates by country](https://www.worldlifeexpectancy.com/cause-of-death/all-cancers/by-country/)

Show those countries on world map, color red, choropleth.


```{r, fig.alt = "This bar graph combines two earlier graphs, those being the most common cancer deaths and the countries with the highest mortality rates per 1000 people. Trachael, bronchus, and lunger cancer deaths are shown to be the most common in these countires, with Monaco having almost two times more of these lung cancer deaths than the leading countries. Colon and rectal cancer mortalities also appear for every country during the years present on the graph, with breast cancer, pancreatic, and testicular being the others present. Japan is the country among the 5 with the highest rate of prostate cancer, and Monaco with pancreatic cancer."}
fig2b <- cancer %>%
  rename(country_code = Code, year = Year) %>% 
  filter(Entity %in% c("Monaco","Hungary","Denmark", "Serbia", "Gernamy", "Croatia", "Japan"), year %in% c(2000,2008,2017)) %>% 
  left_join(world_pop_new %>% 
              filter(year %in% c(2000,2008,2017)) %>% 
              mutate(year = as.numeric(year)),
            by = c("country_code","year")) %>% 
  mutate(death_per_urban = Death_count/total_urban_population*1000, death_per_total = Death_count/ total_population*1000) %>% 
  group_by(Entity, year) %>%
  slice_max(death_per_total, n = 3) %>% 
  ungroup() %>% 
  ggplot(aes(y = Entity, x = death_per_total, fill = fct_infreq(Cancer_type)))+
  geom_col(position = "dodge")+
  facet_wrap(~year)+
  labs(title = "Top Cancer Types causing most deaths per 1000 people in 2000, 2008 and 2017",
       x = "",
       y = "",
       fill = "Types of cancer")+
    theme(legend.position = "bottom",
          plot.title = element_text(hjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank())

fig2b
```
  

Observation: most consistent types of cancer are Tracheal, bronchus and lung cancer, Colon and rectum cancer and breast cancer.

```{r}
fig2a/fig2b
```

=> High death rates by cancer highly concentrated around Europe. Here's a link to maybe why? 
(EU vs USA)[https://www.politico.eu/article/cancer-europe-america-comparison/]
- age? -> Maybe webscape data on Europe's population age? (Cancer more likely as you get older)
- 

```{r, fig.alt = "This graph uses the same three years (2000, 2008, and 2017) and ranks the top 5 countries per year by cancer deaths in their urban populations. There are countries that have appeared before, such as Serbia and Monaco, however they are less prominant. Barbados represents the biggest change from shifting from total population to urban population. Barbados is ranked 3rd, 1st, and 2nd per each year. Saint Lucia also skyrockets from not being present in 2000, 4th place in 2007, and 1st in 2017. Burundi also shows up 1st in 2000, however afterwads falls off the graph entirely."}
#deaths per 1000 urban pop
fig3a <- top_5_cancer_pop %>% 
  filter(year %in% c(2000,2008,2017)) %>% 
  group_by(year) %>% 
  slice_max(death_per_urban, n = 5) %>% 
  ungroup() %>% 
  mutate(country = reorder_within(country, death_per_urban, as.character(year), fun = sum, sep = "___")) %>% 
  ggplot(aes(y = country, x = death_per_urban, fill = country)) +
  geom_col()+
  scale_fill_viridis_d()+
  facet_wrap(~year, scales = "free_y")+
  scale_y_reordered()+
  labs(title = "Top 5 Countries with Highest Percentage of Deaths per 1000 Urban People in 2000, 2008 and 2017",
       x = "",
       y = "")+
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank())

fig3a
```


```{r, fig.alt = "Simiarly to fig2b, this graph shows the most frequent lethal cancers for the countries with the highest deaths per capita in urban areas. While lung cancers continue to be frequent, the three countries not present in fig2b each have a most lethal cancer different from the others. For Barbados, prostate cancer around 40% of the top 3 most lethal cancers, Burundi with cervical cancers, and Saint Lucia with prostate cancer."}
fig3b <- cancer %>%
  rename(country_code = Code, year = Year) %>% 
  filter(Entity %in% c("Burundi","Serbia","Barbados", "Monaco", "Hungary", "Croatia", "Saint Lucia"), year %in% c(2000,2008,2017)) %>% 
  left_join(world_pop_new %>% 
              filter(year %in% c(2000,2008,2017)) %>% 
              mutate(year = as.numeric(year)),
            by = c("country_code","year")) %>% 
  mutate(death_per_urban = Death_count/total_urban_population*1000, death_per_total = Death_count/ total_population*1000) %>% 
  group_by(Entity, year) %>%
  slice_max(death_per_urban, n = 3) %>% 
  ungroup() %>% 
  ggplot(aes(y = Entity, x = death_per_urban, fill = Cancer_type ))+
  geom_col(position = "dodge")+
  facet_wrap(~year)+
  labs(title = "Top Cancer Types causing most deaths per 1000 people in 2000, 2008 and 2017",
       x = "",
       y = "",
       color = "Types of cancer")+
    theme(legend.position = "bottom",
          plot.title = element_text(hjust = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank())

fig3b
```

Observarion: besides the 3 cancer types mentioned earlier, we are also seeing prostate and pancreatic cancer.  

```{r}
fig3a / fig3b
```



```{r}
#comparing cancer death rates vs urban growth rate???
cancer %>% 
  filter(Entity %in% c("Uganda", "Burundi", "Oman", "Tanzania", "Burkina Faso")) %>% 
  group_by(Year, Entity) %>% 
  summarise(Death_count)


#countries with the top 5 urban growths
```


Discussion:
```{r} 
cancer %>%
  group_by(Cancer_type, Year) %>% 
  mutate(Death_count_sum = sum(Death_count)) %>% 
  ggplot(aes(x = Year, y = Death_count_sum, color = Cancer_type)) +
    geom_line()

#What is this doing? - Tam
```

```{r}

```

\
\
**other potentially good stuff**

```{r }

USA <-world_map %>% 
             filter(country == "USA") %>%
             rename(country_code = country)
  filter(country == "United States") %>% 
    ggplot() +
  geom_map(map = ,
           aes(map_id = country_code,
               fill = death/total_population,
               group = year)) +
  expand_limits(x = world_map$long, y = world_map$lat)+
  transition_time(date)+ 
    labs(title = "",
         subtitle = "Date : {frame_time}",
       x="",
       y ="")+
  theme_map()+
  theme(legend.background = element_blank(),
        plot.title = element_text(hjust = 0.5))
  animate(covid_time_map,
          nframes = 300,
          end_pause = 10)
  
```






```{r creating a choropleth world map to see how rate of increase changed for countries over 2000-2017}
  


```






